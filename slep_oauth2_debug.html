<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - SLEP Del Pino (OAuth2 Mejorado)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Google Identity Services (Nueva librer√≠a) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1a1a1a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
            font-weight: 400;
        }

        .date-display {
            background: #f3f4f6;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .auth-status.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .auth-status.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .auth-status.warning {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .course-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .course-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .course-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .course-header i {
            color: #6b7280;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .level-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .level-item h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .level-item h4 i {
            color: #9ca3af;
        }

        .attendance-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
        }

        .input-group input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }

        .summary-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .summary-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .summary-card .percentage {
            font-size: 0.875rem;
            color: #10b981;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .sheet-config {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .sheet-config h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-row {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .input-group.sheet {
            flex: 1;
            min-width: 300px;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: 500;
            white-space: pre-line;
        }

        .status-message.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .status-message.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .status-message.warning {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .status-message.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-panel h4 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.5rem;
            }
            
            .header {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
            
            .level-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .input-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i data-lucide="users"></i>
                Sistema de Registro de Asistencia - SLEP Del Pino
            </h1>
            <p>OAuth2 Mejorado con Debug Detallado</p>
            
            <div class="date-display">
                <i data-lucide="calendar"></i>
                <span id="current-date">Cargando fecha...</span>
            </div>
        </div>

        <!-- Panel de Debug -->
        <div class="debug-panel" id="debug-panel" style="display: none;">
            <h4>üîç Debug Information:</h4>
            <div id="debug-content"></div>
        </div>

        <!-- Configuraci√≥n de Hoja de Google Sheets -->
        <div class="sheet-config">
            <h3>
                <i data-lucide="database"></i>
                Configuraci√≥n de Google Sheets
            </h3>
            <div class="input-row">
                <div class="input-group sheet">
                    <label>Google Sheet ID</label>
                    <input type="text" id="sheet-id-input" placeholder="Ej: 1abc123def456..." value="">
                </div>
                <button class="btn btn-secondary" id="save-sheet-btn">
                    <i data-lucide="save"></i>
                    Guardar ID
                </button>
                <button class="btn btn-primary" id="test-sheet-btn">
                    <i data-lucide="check-circle"></i>
                    Probar Conexi√≥n
                </button>
                <button class="btn btn-warning" id="toggle-debug-btn">
                    <i data-lucide="bug"></i>
                    Debug
                </button>
            </div>
            <div id="sheet-status"></div>
        </div>

        <!-- Secci√≥n de Autenticaci√≥n OAuth2 -->
        <div class="auth-section">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="shield"></i>
                Autenticaci√≥n OAuth2
            </h3>
            
            <div id="auth-status" class="auth-status warning">
                <i data-lucide="alert-circle"></i>
                <span>Estado: No autenticado</span>
            </div>

            <div class="auth-buttons">
                <button class="btn btn-primary" id="sign-in-btn">
                    <i data-lucide="log-in"></i>
                    Iniciar Sesi√≥n con Google
                </button>
                <button class="btn btn-secondary" id="sign-out-btn" style="display: none;">
                    <i data-lucide="log-out"></i>
                    Cerrar Sesi√≥n
                </button>
            </div>

            <div id="auth-message"></div>
        </div>

        <div class="courses-grid" id="courses-container">
            <!-- Los cursos se generar√°n din√°micamente -->
        </div>

        <div class="summary-section">
            <h2>
                <i data-lucide="bar-chart"></i>
                Resumen General
            </h2>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Total de Estudiantes</h3>
                    <div class="value" id="total-students">0</div>
                </div>
                <div class="summary-card">
                    <h3>Presentes</h3>
                    <div class="value" id="total-present">0</div>
                </div>
                <div class="summary-card">
                    <h3>Ausentes</h3>
                    <div class="value" id="total-absent">0</div>
                </div>
                <div class="summary-card">
                    <h3>Asistencia General</h3>
                    <div class="value" id="total-percentage">0%</div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-success" id="save-btn" disabled>
                    <i data-lucide="save"></i>
                    Guardar en Google Sheets
                </button>
                <button class="btn btn-primary" id="export-btn">
                    <i data-lucide="download"></i>
                    Exportar a Excel
                </button>
            </div>

            <div id="save-status"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN =====
        const GOOGLE_CLIENT_ID = '1054856147158-ubr5unhibvvlsrt93e19vc9ks81c0m83.apps.googleusercontent.com';
        const GOOGLE_SHEET_SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // Variables globales
        let googleSheetId = localStorage.getItem('googleSheetId') || '';
        let accessToken = null;
        let userSignedIn = false;
        let debugEnabled = false;

        // Definici√≥n de cursos
        const courses = [
            {
                id: 'elemental',
                name: 'Educaci√≥n B√°sica',
                icon: 'graduation-cap',
                levels: ['1¬∞ B√°sico A', '1¬∞ B√°sico B', '2¬∞ B√°sico A', '2¬∞ B√°sico B', '3¬∞ B√°sico A', '3¬∞ B√°sico B', '4¬∞ B√°sico A', '4¬∞ B√°sico B', '5¬∞ B√°sico A', '5¬∞ B√°sico B', '6¬∞ B√°sico A', '6¬∞ B√°sico B', '7¬∞ B√°sico A', '7¬∞ B√°sico B', '8¬∞ B√°sico A', '8¬∞ B√°sico B']
            },
            {
                id: 'media',
                name: 'Educaci√≥n Media',
                icon: 'school',
                levels: ['1¬∞ Medio A', '1¬∞ Medio B', '2¬∞ Medio A', '2¬∞ Medio B', '3¬∞ Medio A', '3¬∞ Medio B', '4¬∞ Medio A', '4¬∞ Medio B']
            }
        ];

        // ===== FUNCIONES DE DEBUG =====
        function debug(message) {
            if (!debugEnabled) return;
            
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `[${timestamp}] ${message}\n`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(message);
        }

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.style.display = debugEnabled ? 'block' : 'none';
            
            if (debugEnabled) {
                debug('üîç Debug activado');
                debug(`üìß Usuario logueado: ${userSignedIn ? 'S√≠' : 'No'}`);
                debug(`üóÇÔ∏è Sheet ID: ${googleSheetId || 'No configurado'}`);
                debug(`üîë Token disponible: ${accessToken ? 'S√≠' : 'No'}`);
            }
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.getElementById('save-status');
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 8000);
        }

        function showAuthMessage(message, type = 'info') {
            const authMessage = document.getElementById('auth-message');
            authMessage.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => {
                authMessage.innerHTML = '';
            }, 8000);
        }

        function updateAuthStatus(status, message) {
            const authStatus = document.getElementById('auth-status');
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            
            authStatus.className = `auth-status ${status}`;
            
            if (status === 'success') {
                authStatus.innerHTML = `
                    <i data-lucide="check-circle"></i>
                    <span>‚úÖ ${message}</span>
                `;
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-flex';
            } else if (status === 'error') {
                authStatus.innerHTML = `
                    <i data-lucide="x-circle"></i>
                    <span>‚ùå ${message}</span>
                `;
                signInBtn.style.display = 'inline-flex';
                signOutBtn.style.display = 'none';
            } else {
                authStatus.innerHTML = `
                    <i data-lucide="alert-circle"></i>
                    <span>‚ö†Ô∏è ${message}</span>
                `;
                signInBtn.style.display = 'inline-flex';
                signOutBtn.style.display = 'none';
            }
            
            lucide.createIcons();
            
            debug(`üîÑ Estado de autenticaci√≥n: ${status} - ${message}`);
        }

        function updateDateDisplay() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('es-ES', options);
        }

        function generateCourses() {
            const container = document.getElementById('courses-container');
            container.innerHTML = '';

            courses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                
                courseCard.innerHTML = `
                    <div class="course-header">
                        <h3>
                            <i data-lucide="${course.icon}"></i>
                            ${course.name}
                        </h3>
                        <i data-lucide="chevron-down"></i>
                    </div>
                    <div class="level-grid">
                        ${course.levels.map(level => {
                            const levelId = `${course.id}_${level.replace(/\s+/g, '_').replace(/¬∞/g, '')}`;
                            return `
                                <div class="level-item">
                                    <h4>
                                        <i data-lucide="users"></i>
                                        ${level}
                                    </h4>
                                    <div class="attendance-inputs">
                                        <div class="input-group">
                                            <label>Presentes</label>
                                            <input type="number" 
                                                   id="present-${levelId}" 
                                                   min="0" 
                                                   value="0" 
                                                   placeholder="0">
                                        </div>
                                        <div class="input-group">
                                            <label>Ausentes</label>
                                            <input type="number" 
                                                   id="absent-${levelId}" 
                                                   min="0" 
                                                   value="0" 
                                                   placeholder="0">
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(courseCard);
            });
            
            lucide.createIcons();
            attachInputListeners();
        }

        function attachInputListeners() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', updateSummary);
            });
        }

        function updateSummary() {
            let totalStudents = 0;
            let totalPresent = 0;
            let totalAbsent = 0;

            courses.forEach(course => {
                course.levels.forEach(level => {
                    const levelId = `${course.id}_${level.replace(/\s+/g, '_').replace(/¬∞/g, '')}`;
                    const presentInput = document.getElementById(`present-${levelId}`);
                    const absentInput = document.getElementById(`absent-${levelId}`);

                    const present = parseInt(presentInput?.value) || 0;
                    const absent = parseInt(absentInput?.value) || 0;

                    totalPresent += present;
                    totalAbsent += absent;
                });
            });

            totalStudents = totalPresent + totalAbsent;
            const percentage = totalStudents > 0 ? Math.round((totalPresent / totalStudents) * 100) : 0;

            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('total-present').textContent = totalPresent;
            document.getElementById('total-absent').textContent = totalAbsent;
            document.getElementById('total-percentage').textContent = `${percentage}%`;

            // Habilitar bot√≥n de guardar solo si hay datos
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = totalStudents === 0 || !userSignedIn || !googleSheetId;
            
            debug(`üìä Resumen actualizado: ${totalStudents} estudiantes, ${percentage}% asistencia`);
        }

        // ===== GOOGLE IDENTITY SERVICES (GIS) =====
        function initGoogleIdentityServices() {
            debug('üîê Inicializando Google Identity Services...');
            
            if (typeof google === 'undefined' || !google.accounts) {
                debug('‚ùå Google Identity Services no est√° disponible');
                updateAuthStatus('error', 'Google Identity Services no disponible');
                return;
            }

            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            debug('‚úÖ Google Identity Services inicializado');
            updateAuthStatus('warning', 'Listo para autenticaci√≥n');
        }

        function handleCredentialResponse(response) {
            debug('üìù Procesando respuesta de autenticaci√≥n...');
            debug(`üîë Credencial recibida: ${response.credential ? 'S√≠' : 'No'}`);
            
            if (response.credential) {
                accessToken = response.credential;
                userSignedIn = true;
                updateAuthStatus('success', 'Autenticaci√≥n exitosa');
                showAuthMessage('‚úÖ Sesi√≥n iniciada correctamente', 'success');
                updateSummary();
                
                // Inicializar gapi con el token
                initGoogleAPI();
            } else {
                updateAuthStatus('error', 'No se recibi√≥ credencial');
                showAuthMessage('‚ùå Error en la autenticaci√≥n', 'error');
            }
        }

        function signIn() {
            debug('üîë Iniciando proceso de autenticaci√≥n...');
            
            if (typeof google === 'undefined' || !google.accounts) {
                debug('‚ùå Google Identity Services no disponible');
                showAuthMessage('‚ùå Google Identity Services no disponible', 'error');
                return;
            }

            google.accounts.id.prompt();
        }

        function signOut() {
            debug('üö™ Cerrando sesi√≥n...');
            
            accessToken = null;
            userSignedIn = false;
            updateAuthStatus('warning', 'Sesi√≥n cerrada');
            showAuthMessage('üëã Sesi√≥n cerrada', 'info');
            updateSummary();
        }

        // ===== GOOGLE SHEETS API =====
        async function initGoogleAPI() {
            if (!accessToken) {
                debug('‚ùå No hay token de acceso disponible');
                return;
            }

            try {
                debug('üîß Cargando Google API client...');
                
                await new Promise((resolve) => {
                    gapi.load('client', resolve);
                });

                debug('üìã Inicializando Google Sheets API...');
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });

                // Configurar el token para las llamadas a la API
                gapi.client.setToken({ access_token: accessToken });

                debug('‚úÖ Google Sheets API inicializada correctamente');
                showAuthMessage('‚úÖ APIs de Google configuradas', 'success');

            } catch (error) {
                debug(`‚ùå Error inicializando Google API: ${error.message}`);
                showAuthMessage(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testSheetConnection() {
            if (!googleSheetId) {
                debug('‚ö†Ô∏è No hay Sheet ID configurado');
                showStatusMessage('‚ö†Ô∏è Primero ingresa el Google Sheet ID', 'warning');
                return;
            }

            if (!accessToken) {
                debug('‚ö†Ô∏è No hay token de acceso disponible');
                showStatusMessage('‚ö†Ô∏è Primero inicia sesi√≥n con Google', 'warning');
                return;
            }

            try {
                debug(`üîç Probando conexi√≥n con Sheet ID: ${googleSheetId}`);
                
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: googleSheetId
                });

                debug('‚úÖ Conexi√≥n exitosa');
                debug(`üìä Hoja encontrada: ${response.result.properties?.title}`);
                showStatusMessage('‚úÖ Conexi√≥n con Google Sheets exitosa', 'success');

            } catch (error) {
                debug(`‚ùå Error probando conexi√≥n: ${error.message}`);
                
                let errorMessage = 'Error desconocido';
                if (error.status === 404) {
                    errorMessage = 'Hoja no encontrada. Verifica el Sheet ID.';
                } else if (error.status === 403) {
                    errorMessage = 'Sin permisos para acceder a la hoja. Aseg√∫rate de que est√© compartida contigo.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                debug(`üí¨ Mensaje de error: ${errorMessage}`);
                showStatusMessage(`‚ùå ${errorMessage}`, 'error');
            }
        }

        async function saveSheetConfiguration() {
            const sheetIdInput = document.getElementById('sheet-id-input');
            const newSheetId = sheetIdInput.value.trim();

            if (!newSheetId) {
                debug('‚ö†Ô∏è Sheet ID vac√≠o');
                showStatusMessage('‚ö†Ô∏è Ingresa un Sheet ID v√°lido', 'warning');
                return;
            }

            googleSheetId = newSheetId;
            localStorage.setItem('googleSheetId', googleSheetId);
            
            debug(`üíæ Sheet ID guardado: ${googleSheetId}`);
            showStatusMessage('‚úÖ Sheet ID guardado correctamente', 'success');
            updateSummary();
            
            // Probar la conexi√≥n autom√°ticamente
            setTimeout(testSheetConnection, 500);
        }

        async function saveToGoogleSheets() {
            debug('üíæ Iniciando proceso de guardado...');
            
            if (!userSignedIn) {
                debug('‚ùå Usuario no autenticado');
                showStatusMessage('‚ùå Debes iniciar sesi√≥n primero', 'error');
                return;
            }

            if (!googleSheetId) {
                debug('‚ùå No hay Sheet ID configurado');
                showStatusMessage('‚ùå Configura el Sheet ID primero', 'error');
                return;
            }

            try {
                debug('üîÑ Recopilando datos...');
                showStatusMessage('üîÑ Recopilando datos...', 'info');

                // Recopilar datos
                const attendanceData = [];
                let dataCount = 0;

                courses.forEach(course => {
                    debug(`üìö Procesando curso: ${course.name}`);
                    course.levels.forEach(level => {
                        const levelId = `${course.id}_${level.replace(/\s+/g, '_').replace(/¬∞/g, '')}`;
                        const presentInput = document.getElementById(`present-${levelId}`);
                        const absentInput = document.getElementById(`absent-${levelId}`);

                        const present = parseInt(presentInput?.value) || 0;
                        const absent = parseInt(absentInput?.value) || 0;
                        const total = present + absent;
                        const percentage = total > 0 ? Math.round((present / total) * 100) : 0;

                        debug(`  üìä ${level}: ${present} presentes, ${absent} ausentes (${percentage}%)`);

                        if (total > 0) {
                            attendanceData.push([
                                new Date().toLocaleDateString('es-ES'),
                                course.name,
                                level,
                                present,
                                absent,
                                total,
                                percentage,
                                new Date().toLocaleTimeString('es-ES')
                            ]);
                            dataCount++;
                        }
                    });
                });

                debug(`üìä Total de registros a guardar: ${dataCount}`);

                if (attendanceData.length === 0) {
                    debug('‚ö†Ô∏è No hay datos para guardar');
                    showStatusMessage('‚ö†Ô∏è No hay datos para guardar', 'warning');
                    return;
                }

                // Preparar datos para env√≠o
                const headers = ['Fecha', 'Curso', 'Secci√≥n', 'Presentes', 'Ausentes', 'Total', 'Asistencia (%)', 'Hora'];
                const dataToSend = [headers, ...attendanceData];
                
                debug('üì§ Enviando datos a Google Sheets...');
                debug(`üéØ Rango: A:H, registros: ${dataToSend.length}`);
                
                showStatusMessage('üîÑ Guardando en Google Sheets...', 'info');

                // Escribir datos a Google Sheets
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: googleSheetId,
                    range: 'A:H',
                    valueInputOption: 'RAW',
                    resource: { 
                        values: dataToSend
                    }
                });

                debug('‚úÖ Datos guardados exitosamente');
                debug(`üìà Respuesta: ${JSON.stringify(response.result, null, 2)}`);
                showStatusMessage(`‚úÖ Datos guardados exitosamente (${attendanceData.length} registros)`, 'success');

            } catch (error) {
                debug('‚ùå Error en saveToGoogleSheets');
                debug(`üîç Error details: ${JSON.stringify(error, null, 2)}`);
                
                let errorMessage = 'Error desconocido';
                let errorDetails = '';
                
                if (error.status) {
                    errorDetails = ` (HTTP ${error.status})`;
                    if (error.status === 403) {
                        errorMessage = 'Sin permisos para escribir. Verifica que la hoja est√© compartida contigo.';
                    } else if (error.status === 404) {
                        errorMessage = 'Hoja no encontrada. Verifica el Sheet ID.';
                    } else if (error.status === 400) {
                        errorMessage = 'Datos inv√°lidos. Verifica que todos los campos sean correctos.';
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                if (error.result && error.result.error) {
                    errorDetails += `\n${error.result.error.message || 'Error de API'}`;
                }

                debug(`üí¨ Error final: ${errorMessage}${errorDetails}`);
                showStatusMessage(`‚ùå Error al guardar: ${errorMessage}${errorDetails}`, 'error');
            }
        }

        function exportToExcel() {
            debug('üìä Iniciando exportaci√≥n a Excel...');
            try {
                const workbook = XLSX.utils.book_new();
                const data = [];

                courses.forEach(course => {
                    course.levels.forEach(level => {
                        const levelId = `${course.id}_${level.replace(/\s+/g, '_').replace(/¬∞/g, '')}`;
                        const presentInput = document.getElementById(`present-${levelId}`);
                        const absentInput = document.getElementById(`absent-${levelId}`);

                        const present = parseInt(presentInput?.value) || 0;
                        const absent = parseInt(absentInput?.value) || 0;
                        const total = present + absent;
                        const percentage = total > 0 ? Math.round((present / total) * 100) : 0;

                        if (total > 0) {
                            data.push([
                                new Date().toLocaleDateString('es-ES'),
                                course.name,
                                level,
                                present,
                                absent,
                                total,
                                percentage,
                                new Date().toLocaleTimeString('es-ES')
                            ]);
                        }
                    });
                });

                if (data.length === 0) {
                    debug('‚ö†Ô∏è No hay datos para exportar');
                    showStatusMessage('‚ö†Ô∏è No hay datos para exportar', 'warning');
                    return;
                }

                const worksheet = XLSX.utils.aoa_to_sheet([
                    ['Fecha', 'Curso', 'Secci√≥n', 'Presentes', 'Ausentes', 'Total', 'Asistencia (%)', 'Hora']
                ]);

                XLSX.utils.sheet_add_aoa(worksheet, data, { origin: 'A2' });
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Asistencia');

                XLSX.writeFile(workbook, `Asistencia_SLEP_Del_Pino_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                debug('‚úÖ Excel exportado correctamente');
                showStatusMessage(`‚úÖ Archivo Excel exportado (${data.length} registros)`, 'success');

            } catch (error) {
                debug(`‚ùå Error exportando a Excel: ${error.message}`);
                showStatusMessage('‚ùå Error al exportar a Excel', 'error');
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            debug('üîß Configurando event listeners...');
            
            document.getElementById('sign-in-btn').addEventListener('click', signIn);
            document.getElementById('sign-out-btn').addEventListener('click', signOut);
            document.getElementById('test-sheet-btn').addEventListener('click', testSheetConnection);
            document.getElementById('save-sheet-btn').addEventListener('click', saveSheetConfiguration);
            document.getElementById('save-btn').addEventListener('click', saveToGoogleSheets);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('toggle-debug-btn').addEventListener('click', toggleDebug);

            // Auto-save sheet ID cuando se escribe
            const sheetIdInput = document.getElementById('sheet-id-input');
            if (sheetIdInput) {
                sheetIdInput.value = googleSheetId;
                sheetIdInput.addEventListener('input', (e) => {
                    googleSheetId = e.target.value.trim();
                    localStorage.setItem('googleSheetId', googleSheetId);
                });
            }
        }

        // ===== INICIALIZACI√ìN =====
        function init() {
            debug('üöÄ Inicializando aplicaci√≥n OAuth2 mejorada...');
            
            updateDateDisplay();
            generateCourses();
            setupEventListeners();
            
            // Cargar configuraci√≥n guardada
            if (googleSheetId) {
                document.getElementById('sheet-id-input').value = googleSheetId;
                debug(`üíæ Sheet ID cargado desde localStorage: ${googleSheetId}`);
            }
            
            // Inicializar Google Identity Services
            if (typeof google !== 'undefined' && google.accounts) {
                initGoogleIdentityServices();
            } else {
                debug('‚è≥ Esperando que Google Identity Services se cargue...');
                // Intentar de nuevo en 1 segundo
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.accounts) {
                        initGoogleIdentityServices();
                    } else {
                        debug('‚ùå Google Identity Services no disponible despu√©s de esperar');
                        updateAuthStatus('error', 'Google Identity Services no disponible');
                    }
                }, 1000);
            }

            showStatusMessage('üìä Sistema de Registro de Asistencia (OAuth2 Mejorado) cargado', 'success');
        }

        // ===== START APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            debug('üìÑ DOM Content Loaded');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            init();
        });
    </script>
</body>
</html>