<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia - SLEP Del Pino (DEBUG)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1a1a1a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
            font-weight: 400;
        }

        .date-display {
            background: #f3f4f6;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-display i {
            color: #6b7280;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .course-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .course-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .course-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }

        .course-code {
            font-size: 0.875rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .level-section {
            background: #fafbfc;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .level-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .attendance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .attendance-label {
            font-weight: 500;
            color: #4b5563;
        }

        .attendance-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
        }

        .attendance-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .percentage {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
            padding: 0.25rem;
            border-radius: 6px;
            background: #f3f4f6;
            color: #374151;
        }

        .controls {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .config-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .config-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .config-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .connection-status {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.connecting {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .status-dot.error {
            background: #ef4444;
        }

        .status-dot.disconnected {
            background: #6b7280;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-weight: 500;
            color: #374151;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-message.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-message.warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fed7aa;
        }

        .status-message.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .debug-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            color: #0c4a6e;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.5rem;
            }
            
            .levels-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .controls {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i data-lucide="users"></i>
                Registro de Asistencia - SLEP Del Pino
            </h1>
            <p>Sistema de registro de asistencia para estudiantes de 1Â° BÃ¡sico a 4Â° Medio</p>
            <div class="date-display">
                <i data-lucide="calendar"></i>
                <span id="current-date"></span>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="config-section">
            <div class="config-title">
                <i data-lucide="settings"></i>
                ConfiguraciÃ³n de Google Sheets
            </div>
            
            <div class="config-form">
                <div class="form-group">
                    <label class="form-label">Google API Key</label>
                    <input type="text" id="api-key-input" class="form-input" placeholder="AIzaSy...">
                </div>
                <div class="form-group">
                    <label class="form-label">Google Sheet ID</label>
                    <input type="text" id="sheet-id-input" class="form-input" placeholder="1ABC123...">
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <button id="test-api-btn" class="btn btn-warning">
                    <i data-lucide="test-tube"></i>
                    Probar API
                </button>
                <button id="save-config-btn" class="btn btn-success">
                    <i data-lucide="save"></i>
                    Conectar y Configurar
                </button>
            </div>
            
            <div id="connection-status" class="connection-status">
                <div class="status-dot disconnected"></div>
                <span class="status-text">Desconectado</span>
            </div>
            
            <div id="status-message"></div>
            
            <!-- Debug Info -->
            <div id="debug-info" class="debug-info" style="display: none;">
                <strong>DEBUG INFO:</strong><br>
                <span id="debug-text"></span>
            </div>
        </div>

        <!-- Courses Grid -->
        <div id="courses-grid" class="courses-grid">
            <!-- Courses will be generated by JavaScript -->
        </div>

        <!-- Controls -->
        <div class="controls">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button id="save-btn" class="btn btn-primary" disabled>
                    <i data-lucide="cloud-upload"></i>
                    Guardar en Google Sheets
                </button>
                
                <button id="export-btn" class="btn btn-secondary">
                    <i data-lucide="download"></i>
                    Exportar a Excel</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DEBUG LOGGING =====
        const DEBUG = true;
        function debugLog(message, data = null) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`, data);
                // Update debug display if exists
                const debugText = document.getElementById('debug-text');
                if (debugText) {
                    const timestamp = new Date().toLocaleTimeString('es-ES');
                    debugText.innerHTML += `<br>[${timestamp}] ${message}` + (data ? ` - ${JSON.stringify(data)}` : '');
                    document.getElementById('debug-info').style.display = 'block';
                }
            }
        }

        // Clear debug info
        function clearDebug() {
            const debugText = document.getElementById('debug-text');
            if (debugText) {
                debugText.innerHTML = '';
            }
        }

        // ===== CONFIGURATION =====
        let googleAPIKey = '';
        let googleSheetId = '';
        let isConnected = false;
        
        // Course configuration
        const courses = [
            { id: '1basico', name: '1Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '2basico', name: '2Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '3basico', name: '3Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '4basico', name: '4Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '5basico', name: '5Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '6basico', name: '6Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '7basico', name: '7Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '8basico', name: '8Â° BÃ¡sico', levels: ['A', 'B'] },
            { id: '1medio', name: '1Â° Medio', levels: ['A', 'B'] },
            { id: '2medio', name: '2Â° Medio', levels: ['A', 'B'] },
            { id: '3medio', name: '3Â° Medio', levels: ['A', 'B'] },
            { id: '4medio', name: '4Â° Medio', levels: ['A', 'B'] }
        ];

        // ===== UTILITY FUNCTIONS =====
        function updateDateDisplay() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', options);
        }

        function generateCourses() {
            debugLog('Generando cursos...');
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '';
            
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.id = `course-${course.id}`;
                
                card.innerHTML = `
                    <div class="course-header">
                        <div>
                            <div class="course-title">${course.name}</div>
                            <div class="course-code">${course.id.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="levels-grid">
                        ${course.levels.map(level => {
                            const courseId = `${course.id}_${level}`;
                            return `
                                <div class="level-section">
                                    <div class="level-title">
                                        <i data-lucide="users"></i>
                                        SecciÃ³n ${level}
                                    </div>
                                    <div class="attendance-row">
                                        <span class="attendance-label">Presentes:</span>
                                        <input type="number" 
                                               id="present-${courseId}" 
                                               class="attendance-input" 
                                               min="0" 
                                               value="0"
                                               onchange="updatePercentage('${courseId}')">
                                    </div>
                                    <div class="attendance-row">
                                        <span class="attendance-label">Ausentes:</span>
                                        <input type="number" 
                                               id="absent-${courseId}" 
                                               class="attendance-input" 
                                               min="0" 
                                               value="0"
                                               onchange="updatePercentage('${courseId}')">
                                    </div>
                                    <div class="percentage" id="percentage-${courseId}">
                                        Asistencia: 0%
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                grid.appendChild(card);
            });
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            debugLog('Cursos generados correctamente');
        }

        function updatePercentage(courseId) {
            const presentInput = document.getElementById(`present-${courseId}`);
            const absentInput = document.getElementById(`absent-${courseId}`);
            const percentageDisplay = document.getElementById(`percentage-${courseId}`);
            
            if (presentInput && absentInput && percentageDisplay) {
                const present = parseInt(presentInput.value) || 0;
                const absent = parseInt(absentInput.value) || 0;
                const total = present + absent;
                const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                
                percentageDisplay.textContent = `Asistencia: ${percentage}%`;
                percentageDisplay.style.background = percentage >= 90 ? '#ecfdf5' : 
                                                 percentage >= 80 ? '#fffbeb' : '#fef2f2';
                percentageDisplay.style.color = percentage >= 90 ? '#065f46' : 
                                              percentage >= 80 ? '#92400e' : '#991b1b';
            }
        }

        function showStatusMessage(message, type = 'info') {
            debugLog(`Status: ${message} (${type})`);
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status-message ${type}`;
            }
        }

        function updateConnectionStatus(status, text) {
            debugLog(`Connection Status: ${status} - ${text}`);
            const statusDiv = document.getElementById('connection-status');
            const dot = statusDiv.querySelector('.status-dot');
            const textSpan = statusDiv.querySelector('.status-text');
            
            if (dot) {
                dot.className = `status-dot ${status}`;
            }
            if (textSpan) {
                textSpan.textContent = text;
            }
        }

        function loadConfiguration() {
            debugLog('Cargando configuraciÃ³n...');
            googleAPIKey = localStorage.getItem('googleAPIKey') || '';
            googleSheetId = localStorage.getItem('googleSheetId') || '';
            
            const apiKeyInput = document.getElementById('api-key-input');
            const sheetIdInput = document.getElementById('sheet-id-input');
            
            if (apiKeyInput) apiKeyInput.value = googleAPIKey;
            if (sheetIdInput) sheetIdInput.value = googleSheetId;
            
            debugLog(`ConfiguraciÃ³n cargada: API Key=${googleAPIKey ? 'SÃ' : 'NO'}, Sheet ID=${googleSheetId ? 'SÃ' : 'NO'}`);
        }

        // ===== GOOGLE SHEETS INTEGRATION =====
        async function testAPIConnection() {
            debugLog('Iniciando test de API...');
            clearDebug();
            debugLog('ðŸ” Test de API Key iniciado');
            
            if (!googleAPIKey) {
                debugLog('ERROR: API Key estÃ¡ vacÃ­a');
                showStatusMessage('âŒ Ingresa tu API Key primero', 'error');
                return;
            }

            try {
                debugLog(`Probando API Key: ${googleAPIKey.substring(0, 10)}...`);
                
                // Test with Google Sheets API endpoint
                const testUrl = `https://sheets.googleapis.com/v4/spreadsheets?key=${googleAPIKey}`;
                debugLog(`URL de prueba: ${testUrl}`);
                
                const response = await fetch(testUrl);
                debugLog(`Respuesta: Status ${response.status}`);
                
                if (response.status === 400) {
                    const data = await response.json();
                    debugLog('Datos de respuesta:', data);
                    
                    // 400 is actually expected for the /spreadsheets endpoint without parameters
                    if (data.error && data.error.status === 'INVALID_ARGUMENT') {
                        debugLog('âœ… API Key vÃ¡lida (error 400 esperado para endpoint sin parÃ¡metros)');
                        showStatusMessage('âœ… API Key vÃ¡lida', 'success');
                    } else {
                        throw new Error(data.error?.message || 'Error desconocido');
                    }
                } else if (response.ok) {
                    debugLog('âœ… API Key perfectamente vÃ¡lida');
                    showStatusMessage('âœ… API Key vÃ¡lida y funcionando', 'success');
                } else {
                    const data = await response.json();
                    debugLog('Error en respuesta:', data);
                    throw new Error(data.error?.message || `Error HTTP ${response.status}`);
                }
                
            } catch (error) {
                debugLog('ERROR en testAPIConnection:', error);
                showStatusMessage(`âŒ Error con API Key: ${error.message}`, 'error');
            }
        }

        async function initGoogleAPI() {
            debugLog('Iniciando Google API...');
            return new Promise((resolve, reject) => {
                if (typeof gapi === 'undefined') {
                    reject(new Error('Google API client no estÃ¡ cargado'));
                    return;
                }

                debugLog('Cargando Google API client...');
                gapi.load('client', async () => {
                    try {
                        debugLog('Inicializando cliente con API Key...');
                        await gapi.client.init({
                            apiKey: googleAPIKey,
                            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                        });
                        
                        debugLog('Cliente inicializado correctamente');
                        debugLog('Spreadsheet ID:', googleSheetId);
                        
                        // Test connection by getting spreadsheet info
                        await gapi.client.sheets.spreadsheets.get({
                            spreadsheetId: googleSheetId
                        });
                        
                        debugLog('âœ… ConexiÃ³n exitosa con Google Sheets');
                        resolve(true);
                        
                    } catch (error) {
                        debugLog('ERROR en initGoogleAPI:', error);
                        reject(error);
                    }
                });
            });
        }

        async function saveConfiguration() {
            debugLog('Iniciando configuraciÃ³n de conexiÃ³n...');
            clearDebug();
            
            // Get values from inputs
            const apiKeyInput = document.getElementById('api-key-input');
            const sheetIdInput = document.getElementById('sheet-id-input');
            
            if (apiKeyInput) googleAPIKey = apiKeyInput.value.trim();
            if (sheetIdInput) googleSheetId = sheetIdInput.value.trim();
            
            debugLog('Valores obtenidos:');
            debugLog(`API Key: ${googleAPIKey ? 'SÃ (' + googleAPIKey.length + ' chars)' : 'NO'}`);
            debugLog(`Sheet ID: ${googleSheetId ? 'SÃ (' + googleSheetId.length + ' chars)' : 'NO'}`);
            
            if (!googleAPIKey || !googleSheetId) {
                debugLog('ERROR: API Key o Sheet ID faltante');
                showStatusMessage('âš ï¸ Completa API Key y Sheet ID', 'warning');
                return;
            }

            updateConnectionStatus('connecting', 'Conectando con Google Sheets...');
            
            try {
                await initGoogleAPI();
                
                // Save to localStorage
                localStorage.setItem('googleAPIKey', googleAPIKey);
                localStorage.setItem('googleSheetId', googleSheetId);
                
                isConnected = true;
                updateConnectionStatus('connected', 'âœ… Conectado a Google Sheets');
                
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) saveBtn.disabled = false;
                
                showStatusMessage('âœ… ConexiÃ³n exitosa configurada', 'success');
                debugLog('âœ… ConfiguraciÃ³n guardada correctamente');
                
            } catch (error) {
                debugLog('ERROR en saveConfiguration:', error);
                isConnected = false;
                updateConnectionStatus('error', 'âŒ Error de conexiÃ³n');
                
                let errorMsg = 'Error desconocido';
                if (error.result?.error) {
                    const err = error.result.error;
                    if (err.status === 'PERMISSION_DENIED') {
                        errorMsg = 'Sin permisos para acceder a la hoja. Verifica que estÃ© compartida contigo.';
                    } else if (err.status === 'NOT_FOUND') {
                        errorMsg = 'Hoja de cÃ¡lculo no encontrada. Verifica el Sheet ID.';
                    } else {
                        errorMsg = err.message || `Error: ${err.status}`;
                    }
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                showStatusMessage(`âŒ Error de conexiÃ³n: ${errorMsg}`, 'error');
            }
        }

        // ===== SAVE TO GOOGLE SHEETS (ENHANCED DEBUG) =====
        async function saveToGoogleSheets() {
            debugLog('ðŸ—‚ï¸ Iniciando saveToGoogleSheets()');
            debugLog(`isConnected: ${isConnected}`);
            debugLog(`googleSheetId: ${googleSheetId}`);
            debugLog(`googleAPIKey: ${googleAPIKey ? 'PRESENTE' : 'AUSENTE'}`);
            
            if (!isConnected) {
                debugLog('ERROR: No estÃ¡ conectado');
                showStatusMessage('âš ï¸ Configura la conexiÃ³n primero', 'warning');
                return;
            }

            try {
                showStatusMessage('ðŸ”„ Preparando datos...', 'info');
                debugLog('ðŸ”„ Recopilando datos de asistencia...');
                
                const attendanceData = [];
                let validEntries = 0;
                
                // Collect all data with enhanced validation
                courses.forEach(course => {
                    course.levels.forEach(level => {
                        const courseId = `${course.id}_${level}`;
                        const presentInput = document.getElementById(`present-${courseId}`);
                        const absentInput = document.getElementById(`absent-${courseId}`);

                        debugLog(`Procesando ${course.name} - SecciÃ³n ${level}`);
                        debugLog(`presentInput existe: ${!!presentInput}`);
                        debugLog(`absentInput existe: ${!!absentInput}`);
                        
                        if (presentInput && absentInput) {
                            const present = parseInt(presentInput.value) || 0;
                            const absent = parseInt(absentInput.value) || 0;
                            const total = present + absent;

                            debugLog(`Valores: Presentes=${present}, Ausentes=${absent}, Total=${total}`);
                            
                            // Only add if there's data to save
                            if (total > 0) {
                                const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                                
                                const rowData = [
                                    new Date().toLocaleDateString('es-ES'),
                                    course.name,
                                    level,
                                    present,
                                    absent,
                                    total,
                                    percentage,
                                    new Date().toLocaleTimeString('es-ES')
                                ];
                                
                                attendanceData.push(rowData);
                                validEntries++;
                                debugLog(`âœ… Entrada vÃ¡lida aÃ±adida:`, rowData);
                            } else {
                                debugLog('âš ï¸ No se aÃ±ade - sin datos vÃ¡lidos');
                            }
                        } else {
                            debugLog('âŒ Elementos no encontrados en DOM');
                        }
                    });
                });

                debugLog(`Datos recopilados: ${attendanceData.length} registros vÃ¡lidos`);
                debugLog('Estructura de datos:', attendanceData);

                if (attendanceData.length === 0) {
                    debugLog('ERROR: No hay datos para guardar');
                    showStatusMessage('âš ï¸ No hay datos para guardar. Ingresa al menos un nÃºmero en los campos de asistencia.', 'warning');
                    return;
                }

                showStatusMessage(`ðŸ“ Guardando ${validEntries} registros...`, 'info');
                debugLog(`ðŸ“ Iniciando guardado de ${validEntries} registros...`);
                debugLog('Estructura que se enviarÃ¡ a Google Sheets:', JSON.stringify(attendanceData, null, 2));

                // Save to Google Sheets with comprehensive error handling
                try {
                    debugLog('ðŸ“¤ Realizando llamada a Google Sheets API...');
                    debugLog('ParÃ¡metros de la llamada:');
                    debugLog(`- spreadsheetId: ${googleSheetId}`);
                    debugLog(`- range: A:H`);
                    debugLog(`- valueInputOption: RAW`);
                    debugLog(`- values count: ${attendanceData.length}`);
                    
                    const startTime = Date.now();
                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: googleSheetId,
                        range: 'A:H',
                        valueInputOption: 'RAW',
                        resource: {
                            values: attendanceData
                        }
                    });
                    const endTime = Date.now();
                    
                    debugLog(`âœ… Llamada completada en ${endTime - startTime}ms`);
                    debugLog('Respuesta de Google Sheets:', response);
                    
                    showStatusMessage(`âœ… Datos guardados exitosamente (${validEntries} registros)`, 'success');
                    debugLog('ðŸŽ‰ Guardado exitoso completado');
                    
                } catch (apiError) {
                    debugLog('âŒ ERROR en Google Sheets API:');
                    debugLog('Error object:', apiError);
                    debugLog('Error result:', apiError.result);
                    debugLog('Error message:', apiError.message);
                    
                    // Handle API-specific errors
                    let errorMessage = 'Error desconocido al guardar';
                    
                    if (apiError.result && apiError.result.error) {
                        const error = apiError.result.error;
                        debugLog('Error details from API:', error);
                        
                        if (error.status === 'PERMISSION_DENIED') {
                            errorMessage = 'Sin permisos para escribir en la hoja. Verifica que estÃ© compartida contigo.';
                        } else if (error.status === 'INVALID_ARGUMENT') {
                            errorMessage = 'ID de hoja invÃ¡lido. Verifica que el Sheet ID sea correcto.';
                        } else if (error.status === 'NOT_FOUND') {
                            errorMessage = 'Hoja no encontrada. Verifica el Sheet ID.';
                        } else if (error.message) {
                            errorMessage = error.message;
                        } else {
                            errorMessage = `Error de API: ${error.status}`;
                        }
                    } else if (apiError.message) {
                        errorMessage = apiError.message;
                    }
                    
                    debugLog(`Error message final: ${errorMessage}`);
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                debugLog('âŒ ERROR GENERAL en saveToGoogleSheets:');
                debugLog('Error type:', typeof error);
                debugLog('Error:', error);
                debugLog('Error stack:', error.stack);
                
                // Get a readable error message
                let errorMsg = 'Error desconocido';
                
                if (error && typeof error === 'string') {
                    errorMsg = error;
                } else if (error && error.message) {
                    errorMsg = error.message;
                } else if (error && error.result && error.result.error) {
                    errorMsg = error.result.error.message || 'Error de API';
                }
                
                debugLog(`Final error message: ${errorMsg}`);
                showStatusMessage(`âŒ Error al guardar: ${errorMsg}`, 'error');
            }
        }

        function exportToExcel() {
            debugLog('ðŸ“Š Iniciando exportaciÃ³n a Excel...');
            try {
                const workbook = XLSX.utils.book_new();
                const data = [];

                // Collect all data
                courses.forEach(course => {
                    course.levels.forEach(level => {
                        const courseId = `${course.id}_${level}`;
                        const presentInput = document.getElementById(`present-${courseId}`);
                        const absentInput = document.getElementById(`absent-${courseId}`);

                        const present = parseInt(presentInput?.value) || 0;
                        const absent = parseInt(absentInput?.value) || 0;
                        const total = present + absent;
                        const percentage = total > 0 ? Math.round((present / total) * 100) : 0;

                        data.push([
                            new Date().toLocaleDateString('es-ES'),
                            course.name,
                            level,
                            present,
                            absent,
                            total,
                            percentage,
                            new Date().toLocaleTimeString('es-ES')
                        ]);
                    });
                });

                if (data.length === 0) {
                    showStatusMessage('âš ï¸ No hay datos para exportar', 'warning');
                    return;
                }

                const worksheet = XLSX.utils.aoa_to_sheet([
                    ['Fecha', 'Curso', 'SecciÃ³n', 'Presentes', 'Ausentes', 'Total', 'Asistencia (%)', 'Hora']
                ]);

                XLSX.utils.sheet_add_aoa(worksheet, data, { origin: 'A2' });
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Asistencia');

                XLSX.writeFile(workbook, `Asistencia_SLEP_Del_Pino_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showStatusMessage(`âœ… Archivo Excel exportado (${data.length} registros)`, 'success');
                debugLog('âœ… ExportaciÃ³n a Excel completada');
                
            } catch (error) {
                debugLog('âŒ Error en exportToExcel:', error);
                showStatusMessage('âŒ Error al exportar a Excel', 'error');
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            debugLog('Configurando event listeners...');
            
            const testApiBtn = document.getElementById('test-api-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const saveBtn = document.getElementById('save-btn');
            const exportBtn = document.getElementById('export-btn');

            if (testApiBtn) testApiBtn.addEventListener('click', testAPIConnection);
            if (saveConfigBtn) saveConfigBtn.addEventListener('click', saveConfiguration);
            if (saveBtn) saveBtn.addEventListener('click', saveToGoogleSheets);
            if (exportBtn) exportBtn.addEventListener('click', exportToExcel);

            debugLog('Event listeners configurados correctamente');
        }

        // ===== INITIALIZATION =====
        function init() {
            debugLog('ðŸš€ Iniciando aplicaciÃ³n...');
            clearDebug();
            updateDateDisplay();
            generateCourses();
            loadConfiguration();
            setupEventListeners();

            showStatusMessage('ðŸ“Š Sistema de Registro de Asistencia cargado (DEBUG)', 'success');
            
            if (!googleAPIKey || !googleSheetId) {
                showStatusMessage('âš™ï¸ Configura tu API Key y Sheet ID para comenzar', 'info');
                updateConnectionStatus('error', 'ConfiguraciÃ³n requerida');
            }
        }

        // ===== START APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('ðŸ“„ DOM Content Loaded');
            if (typeof lucide !== 'undefined') {
                debugLog('âœ¨ Inicializando Lucide icons...');
                lucide.createIcons();
            }
            init();
        });
    </script>
</body>
</html>